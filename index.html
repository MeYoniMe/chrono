<!DOCTYPE html>
<html lang="fr">
<!-- © 2026 Yoni - All rights reserved -->    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRON TIMER - Tactical Training</title>
    <meta name="description" content="Application de chronométrage sportif haute visibilité.">
    
    <!-- CONFIGURATION ICONE -->
    <link rel="icon" type="image/png" href="ICONE.png">
    <link rel="apple-touch-icon" href="ICONE.png">

    <!-- Configuration iOS Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    
    <!-- Importation Police Tactique -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- CONFIGURATION GRAPHIQUE --- */
        :root {
            --color-kevlar: #1a1a1a;
            --color-volt: #CCFF00;
            --color-alert: #FF3333;
            --color-rest: #00C2FF;
            --color-zen: #d946ef;
            --color-white: #ffffff;
            --font-tactical: 'Chakra Petch', sans-serif;
            --font-display: 'Black Ops One', cursive;
        }

        body {
            background-color: #0f0f0f;
            color: var(--color-white);
            font-family: var(--font-tactical);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* Texture Kevlar */
        .bg-kevlar {
            background-color: #111;
            background-image: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a),
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            box-shadow: inset 0 0 100px #000;
        }

        /* --- UI ELEMENTS --- */
        .text-neon-volt { color: var(--color-volt); text-shadow: 0 0 15px rgba(204, 255, 0, 0.6); }
        .text-neon-alert { color: var(--color-alert); text-shadow: 0 0 15px rgba(255, 51, 51, 0.6); }
        .text-neon-zen { color: var(--color-zen); text-shadow: 0 0 20px rgba(217, 70, 239, 0.8); }
        
        .font-display { font-family: var(--font-display); letter-spacing: 2px; }

        .btn-tactical {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }
        .btn-tactical:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }
        .btn-action {
            background: var(--color-volt);
            color: #000;
            border: none;
            box-shadow: 0 0 25px rgba(204, 255, 0, 0.4);
            font-family: var(--font-display);
        }
        .btn-close {
            background: #4a0000;
            border: 2px solid #ff0000;
            color: #ffcccc;
            font-family: var(--font-display);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
            z-index: 50;
            cursor: pointer;
        }
        .btn-restart {
            background: #00334a;
            border: 2px solid #00C2FF;
            color: #00C2FF;
            font-family: var(--font-display);
            box-shadow: 0 0 15px rgba(0, 194, 255, 0.3);
            z-index: 50;
            cursor: pointer;
        }

        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 0px #FF3333; }
            50% { box-shadow: inset 0 0 80px #FF3333; }
            100% { box-shadow: inset 0 0 0px #FF3333; }
        }
        .animate-alert { animation: pulse-red 1s infinite; }

        .hidden-force { display: none !important; }
        
        .copyright-footer-fixed {
            position: fixed; bottom: 15px; left: 0; width: 100%;
            font-size: 10px; color: #666; text-align: center;
            font-family: sans-serif; letter-spacing: 0.5px;
            z-index: 9998; pointer-events: none; padding: 0 10px;
        }

        #orientation-lock-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            color: var(--color-volt);
        }
        @media screen and (orientation: landscape) and (max-height: 600px) {
            #orientation-lock-screen { display: flex; }
        }
    </style>
</head>
<body class="bg-kevlar flex flex-col items-center justify-center">

    <div id="orientation-lock-screen">
        <div class="text-6xl mb-4">↻</div>
        <h2 class="text-2xl font-display uppercase tracking-widest mb-2">MODE PORTRAIT REQUIS</h2>
        <p class="text-gray-400 text-sm px-8">Tournez votre appareil.</p>
    </div>

    <audio id="ios-audio-hack" loop muted playsinline style="width: 1px; height: 1px; opacity: 0;">
        <source src="data:audio/mp3;base64,//MkxAA........" type="audio/mpeg">
    </audio>

    <!-- DISCLAIMER -->
    <div id="screen-disclaimer" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center p-8 text-center">
        <div class="absolute top-4 left-4 text-xs text-gray-600 font-display opacity-50">By Y.B</div>
        <h1 class="text-4xl text-red-600 font-display mb-6 drop-shadow-[0_0_10px_rgba(255,0,0,0.5)]">ATTENTION</h1>
        
        <div class="border border-red-900 bg-red-900/10 p-6 rounded-lg mb-4 w-full max-w-md">
            <p class="text-lg leading-relaxed mb-4 font-bold text-gray-200">
                Cette application est conçue pour des entraînements INTENSIFS.
            </p>
            <p class="text-sm text-gray-400 leading-relaxed">
                L'auteur décline toute responsabilité en cas de blessure ou de malaise. 
                Consultez un médecin avant de commencer un programme sportif.
            </p>
        </div>

        <div class="mb-8 font-display text-gray-500 tracking-widest text-sm">
            BY YONI BRD
        </div>

        <button onclick="app.acceptDisclaimer()" class="btn-tactical btn-action w-full max-w-md py-5 text-2xl rounded tracking-widest">
            J'ACCEPTE • ENTRER
        </button>

        <div class="copyright-footer-fixed">
            Copyright © 2026 Yoni Brd. All rights reserved.<br>
            Source code protected. Unauthorized reproduction prohibited.
        </div>
    </div>

    <!-- MENU PRINCIPAL -->
    <div id="screen-menu" class="w-full h-full flex flex-col p-4 hidden-force pt-8">
        
        <!-- HEADER -->
        <div class="flex flex-col items-center mb-6 mt-4 w-full max-w-md mx-auto">
            <h2 class="text-4xl sm:text-6xl md:text-7xl font-display text-white tracking-widest drop-shadow-lg text-center leading-none w-full whitespace-nowrap px-2">IRON TIMER</h2>
        </div>
        
        <!-- BOUTONS / CASES -->
        <div class="grid grid-cols-1 gap-3 flex-1 overflow-y-auto pb-4 max-w-md mx-auto w-full">
            <button onclick="app.setupMode('tabata')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-l-[var(--color-volt)] text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">TABATA</span></div>
                <p class="text-xs text-gray-400">Cardio Max. Brûle-graisse.</p>
            </button>

            <button onclick="app.setupMode('boxing')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-l-red-600 text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">SPARRING</span></div>
                <p class="text-xs text-gray-400">Endurance combat & Souffle.</p>
            </button>

            <button onclick="app.setupMode('lafay')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-l-blue-500 text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">MÉTHODE X</span></div>
                <p class="text-xs text-gray-400">Reps libres. Repos strict.</p>
            </button>

            <button onclick="app.setupMode('running')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-l-orange-500 text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">COURSE</span></div>
                <p class="text-xs text-gray-400">Chronomètre + Tours (Laps).</p>
            </button>

             <button onclick="app.setupMode('custom')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-white text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">LIBRE</span></div>
                <p class="text-xs text-gray-400">Personnalisation totale.</p>
            </button>

            <button onclick="app.setupMode('coherence')" class="btn-tactical flex-col p-5 rounded-xl border-l-8 border-l-purple-500 text-left">
                <div class="flex justify-between w-full items-center mb-1"><span class="text-3xl text-white font-display">RETOUR AU CALME</span></div>
                <p class="text-xs text-gray-400">Respiration apaisante. 5min.</p>
            </button>
        </div>
    </div>

    <!-- REGLAGES -->
    <div id="screen-setup" class="w-full h-full flex flex-col p-3 hidden-force pt-10 max-w-md mx-auto pb-2 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <button onclick="AudioEngine.init(); app.showScreen('screen-menu')" class="text-gray-400 text-xs font-bold border border-gray-600 w-10 h-10 flex items-center justify-center rounded active:bg-gray-800"><</button>
            <h2 id="setup-title" class="text-xl font-display text-white text-right truncate ml-2">REGLAGES</h2>
        </div>
        <div class="bg-gray-900/80 p-3 rounded border border-gray-700 mb-2 shadow-lg shrink-0">
            <div class="flex items-center gap-2 mb-1 text-yellow-400 font-bold">
                <span class="text-base">ℹ️</span> <span>INFO</span>
            </div>
            <p id="setup-science-text" class="text-xs text-gray-300 leading-tight">...</p>
        </div>
        <div id="setup-controls" class="space-y-2 mb-2 shrink-0"></div>
        <div class="mt-4 w-full pt-2">
            <button onclick="app.startWorkout()" class="btn-tactical btn-action w-full py-5 text-4xl rounded-sm font-display tracking-widest text-black transform active:scale-95 transition-transform shadow-lg">GO !</button>
        </div>
    </div>

    <!-- MODAL CONFIRMATION RESTART -->
    <div id="modal-confirm" class="hidden-force absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-8 backdrop-blur-sm">
        <h3 class="text-3xl text-white font-display mb-8 text-center uppercase tracking-widest leading-relaxed">RECOMMENCER<br>LA SÉANCE ?</h3>
        <div class="flex gap-4 w-full max-w-xs">
            <button onclick="app.closeModal()" class="btn-tactical flex-1 py-5 bg-gray-800 text-white border-gray-600 rounded text-xl">NON</button>
            <button onclick="app.confirmRestart()" class="btn-tactical flex-1 py-5 bg-[var(--color-volt)] text-black border-none rounded text-xl shadow-[0_0_20px_rgba(204,255,0,0.4)]">OUI</button>
        </div>
    </div>

    <!-- CHRONO -->
    <div id="screen-timer" class="w-full h-full flex flex-col hidden-force relative bg-black">
        <div id="sidebar-left-container" class="absolute left-0 top-0 bottom-0 w-10 bg-gray-900 z-0 border-r border-gray-800">
            <div id="visual-bar-left" class="w-full bg-white transition-all duration-1000 ease-linear absolute bottom-0 h-full"></div>
        </div>
        <div id="sidebar-right-container" class="absolute right-0 top-0 bottom-0 w-10 bg-gray-900 z-0 border-l border-gray-800">
            <div id="visual-bar-right" class="w-full bg-white transition-all duration-1000 ease-linear absolute bottom-0 h-full"></div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-between py-6 px-12 z-10 w-full max-w-2xl mx-auto">
            <div class="w-full flex justify-between items-start mt-2">
                <button id="btn-restart" onclick="app.restartWorkout()" class="btn-restart w-10 h-10 flex items-center justify-center text-xl rounded shadow-lg active:scale-90 transition-transform font-bold mr-4" style="touch-action: manipulation;">↻</button>
                <div class="text-left flex-1">
                    <div id="timer-phase-label" class="text-3xl font-bold uppercase text-gray-400 tracking-wider">EFFORT</div>
                    <div id="timer-round-counter" class="text-xl text-white mt-1 font-mono">SERIE 1 / 8</div>
                </div>
                <button onclick="app.quitWorkout()" class="btn-close w-10 h-10 flex items-center justify-center text-xl rounded shadow-lg active:scale-90 transition-transform font-bold" style="touch-action: manipulation;">X</button>
            </div>

            <div id="reps-visualizer" class="flex gap-2 mt-6 w-full flex-wrap justify-center opacity-90"></div>

            <div class="flex flex-col items-center justify-center my-auto w-full">
                <div id="timer-display" class="font-display text-[32vw] leading-none tabular-nums text-center drop-shadow-2xl">00</div>
                <div id="timer-sub-display" class="text-3xl mt-4 text-gray-400 font-bold uppercase tracking-[0.3em]">SECONDES</div>
                <div id="laps-container" class="w-full hidden-force mt-4 space-y-2 max-h-40 overflow-y-auto"></div>
            </div>

            <div class="w-full mb-4">
                <button id="main-action-btn" onclick="app.handleAction()" class="btn-tactical w-full py-8 text-3xl bg-gray-800 border-gray-500 rounded hidden-force shadow-2xl font-display">FINI > REPOS</button>
                <div id="lafay-actions" class="flex flex-col gap-3 w-full hidden-force">
                    <button onclick="app.handleLafayRest('reps')" class="btn-tactical w-full py-6 text-xl bg-orange-600 text-white border-none font-bold shadow-lg">
                        <span class="block text-sm mr-2 opacity-75">REPOS REPS</span>
                        <span id="label-rest-reps" class="font-display text-2xl">25s</span>
                    </button>
                    <div class="flex gap-3 w-full">
                        <button onclick="app.handleLafayRest('short')" class="btn-tactical flex-1 py-8 text-xl bg-[var(--color-volt)] text-black border-none font-bold">
                            <span class="block text-sm mb-1">SÉRIE FINIE</span>
                            <span id="label-rest-short" class="font-display text-3xl">25s</span>
                        </button>
                        <button onclick="app.handleLafayRest('long')" class="btn-tactical flex-1 py-8 text-xl bg-blue-600 text-white border-none font-bold">
                            <span class="block text-sm text-blue-200 mb-1">SÉRIE FINIE</span>
                            <span id="label-rest-long" class="font-display text-3xl">180s</span>
                        </button>
                    </div>
                </div>
                <div id="controls-standard" class="flex gap-2 w-full mt-2">
                    <button id="btn-pause-toggle" onclick="app.togglePause()" class="btn-tactical flex-1 py-8 text-2xl bg-gray-800/90 border-gray-600">PAUSE</button>
                </div>
                <div id="controls-running" class="flex gap-4 w-full hidden-force">
                    <button id="btn-lap" onclick="app.recordLap()" class="btn-tactical flex-1 py-8 text-2xl bg-blue-900/90 border-blue-500">TOUR</button>
                    <button id="btn-stop-run" onclick="app.toggleRun()" class="btn-tactical flex-1 py-8 text-2xl bg-[var(--color-volt)] text-black border-none">START</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MOTEUR JS -->
    <script>
        const AudioEngine = {
            ctx: null,
            init: function() {
                // Son activé par défaut (suppression check soundEnabled)
                if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
                if (this.ctx.state === 'suspended') { this.ctx.resume(); }
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    gain.gain.value = 0.001; 
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(0);
                    osc.stop(0.1);
                } catch(e){}
            },
            playBell: function(freq, type='sawtooth', duration=1.5, vol=1.0) { 
                if (!this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    const now = this.ctx.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(vol, now + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now);
                    osc.stop(now + duration);
                } catch(e) { console.error(e); }
            },
            beepCountdown: function() { this.playBell(1000, 'square', 0.15, 0.6); },
            beepTabataStart: function() { this.playBell(1000, 'sawtooth', 2.0, 1.0); },
            beepTripleStart: function() { 
                const freq = 1046;
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.4, 1.0), 0);
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.4, 1.0), 200);
                setTimeout(() => this.playBell(freq, 'sawtooth', 1.2, 1.0), 400);
            },
            beepRoundEnd: function() {
                const freq = 784; 
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.6, 1.0), 0);
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.6, 1.0), 400);
                setTimeout(() => this.playBell(freq, 'sawtooth', 1.5, 1.0), 800);
            },
            beepEndFight: function() {
                const freq = 523;
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.8, 1.0), 0);
                setTimeout(() => this.playBell(freq, 'sawtooth', 0.8, 1.0), 500);
                setTimeout(() => this.playBell(freq, 'sawtooth', 2.5, 1.0), 1000);
            },
            beepHigh: function() { this.playBell(880, 'sine', 1.5, 1.0); }, 
            buzzer: function() { this.playBell(440, 'triangle', 1.5, 0.8); }, 
            zenInhale: function() { this.playBell(432, 'sine', 3.0, 0.6); },   
            zenHold: function() { this.playBell(528, 'sine', 2.5, 0.5); },     
            zenExhale: function() { this.playBell(324, 'sine', 3.5, 0.7); }    
        };

        const WakeLock = {
            lock: null,
            async request() {
                if ('wakeLock' in navigator) {
                    try { this.lock = await navigator.wakeLock.request('screen'); } catch (err) {}
                }
                document.getElementById('ios-audio-hack').play().catch(e=>{});
            },
            release() { if (this.lock) { this.lock.release(); this.lock = null; } }
        };

        const MODES = {
            tabata: { name: "TABATA 20/10", desc: "Le protocole original. 20s effort, 10s repos. Améliore aérobie et anaérobie.", work: 20, hold: 0, rest: 10, sets: 8, type: 'interval', unit: 'RÉPÉTITION' },
            boxing: { name: "SPARRING PRO", desc: "3 min combat, 1 min repos. Gestion de l'effort sur la durée.", work: 180, hold: 0, rest: 60, sets: 12, type: 'interval', unit: 'ROUND' },
            lafay: { name: "MÉTHODE X", desc: "Temps d'effort libre (vos reps), repos strict. Idéal pour la musculation au poids de corps.", work: 0, hold: 0, rest: 25, rest_reps: 25, rest_short: 25, rest_long: 180, sets: 6, type: 'manual', unit: 'RÉPÉTITION' },
            running: { name: "COURSE", desc: "Chronomètre simple avec gestion des tours. Comparez vos temps.", type: 'stopwatch' },
            custom: { name: "PERSONNALISÉ", desc: "Réglez vos temps. Mettez une valeur à 0 pour désactiver cette phase.", work: 30, hold: 0, rest: 30, sets: 5, type: 'interval', unit: 'RÉPÉTITION' },
            coherence: { name: "RETOUR AU CALME", desc: "Respiration apaisante. 5s inspi / 5s expi. Apaise le système nerveux sur 5min.", work: 5, hold: 0, rest: 5, sets: 30, type: 'interval', unit: 'CYCLE' }
        };

        const app = {
            state: { currentScreen: 'screen-disclaimer', mode: null, config: {}, running: false, paused: false, phase: 'ready', timeLeft: 0, totalTime: 0, currentSet: 1, intervalId: null, elapsedTime: 0, laps: [], lafayAction: null },
            showScreen: function(screenId) {
                document.querySelectorAll('body > div').forEach(el => {
                    if(el.id !== 'ios-audio-hack' && !el.classList.contains('copyright-footer-fixed') && el.id !== 'orientation-lock-screen') el.classList.add('hidden-force');
                });
                document.getElementById(screenId).classList.remove('hidden-force');
                this.state.currentScreen = screenId;
            },
            acceptDisclaimer: function() {
                localStorage.setItem('iron-timer-accepted', 'true');
                AudioEngine.init();
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().then(() => {
                        if (screen.orientation && screen.orientation.lock) screen.orientation.lock('portrait').catch(e => console.log('Lock failed', e));
                    }).catch(e => console.log('Fullscreen failed', e));
                }
                this.showScreen('screen-menu');
            },
            setupMode: function(modeKey) {
                this.state.mode = modeKey;
                this.state.config = JSON.parse(JSON.stringify(MODES[modeKey]));
                document.getElementById('setup-title').innerText = this.state.config.name;
                document.getElementById('setup-science-text').innerText = this.state.config.desc;
                const controls = document.getElementById('setup-controls');
                controls.innerHTML = ''; 
                const createInput = (label, key, val, step) => `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-600 shadow-md">
                        <label class="text-gray-200 font-bold text-sm">${label}</label>
                        <div class="flex items-center gap-2">
                            <button onclick="app.adjustConfig('${key}', -${step})" class="w-10 h-10 bg-gray-700 rounded text-xl font-bold active:bg-gray-600 shadow border border-gray-600">-</button>
                            <span id="conf-${key}" class="w-14 text-center text-xl font-display text-white">${val}</span>
                            <button onclick="app.adjustConfig('${key}', ${step})" class="w-10 h-10 bg-gray-700 rounded text-xl font-bold active:bg-gray-600 shadow border border-gray-600">+</button>
                        </div>
                    </div>`;
                let labelSets = "SÉRIES";
                if(this.state.mode === 'boxing') labelSets = "ROUNDS";
                else if(this.state.mode === 'coherence') labelSets = "CYCLES";
                else labelSets = "RÉPÉTITIONS";
                if (this.state.config.type === 'interval') {
                    if(this.state.mode === 'coherence') {
                        controls.innerHTML += createInput("INSPIRER", 'work', this.state.config.work, 1);
                        controls.innerHTML += createInput("MAINTENIR", 'hold', this.state.config.hold, 1);
                        controls.innerHTML += createInput("EXPIRER", 'rest', this.state.config.rest, 1);
                        controls.innerHTML += createInput(labelSets, 'sets', this.state.config.sets, 5);
                    } else {
                        controls.innerHTML += createInput("EFFORT", 'work', this.state.config.work, 5);
                        controls.innerHTML += createInput("REPOS", 'rest', this.state.config.rest, 5);
                        controls.innerHTML += createInput(labelSets, 'sets', this.state.config.sets, 1);
                    }
                } else if (this.state.config.type === 'manual') {
                    controls.innerHTML += createInput("REPOS REPS", 'rest_reps', this.state.config.rest_reps, 5);
                    controls.innerHTML += createInput("REPOS 1", 'rest_short', this.state.config.rest_short, 5);
                    controls.innerHTML += createInput("REPOS 2", 'rest_long', this.state.config.rest_long, 5);
                    controls.innerHTML += createInput(labelSets, 'sets', this.state.config.sets, 1);
                }
                this.showScreen('screen-setup');
            },
            adjustConfig: function(key, delta) {
                let current = this.state.config[key];
                let step = Math.abs(delta);
                if(step === 1 && key !== 'sets' && this.state.mode !== 'coherence') step = 5; 
                let newVal;
                let min = 0; 
                if (key === 'sets' || (key === 'work' && this.state.mode !== 'custom') || (key === 'rest' && this.state.mode !== 'custom') || key.includes('rest_')) min = 1;
                if (delta > 0) {
                    if (current === 1 && step === 5) newVal = 5;
                    else newVal = current + step;
                } else {
                    newVal = current - step;
                }
                if (this.state.mode !== 'coherence' && step === 5 && newVal % 5 !== 0 && newVal !== 1 && newVal !== 0) newVal = Math.round(newVal / 5) * 5;
                if (newVal < min) newVal = min;
                if (this.state.mode === 'custom' && newVal === 0) {
                    if (key === 'work' && this.state.config.rest === 0) newVal = 5;
                    if (key === 'rest' && this.state.config.work === 0) newVal = 5;
                }
                this.state.config[key] = newVal;
                document.getElementById(`conf-${key}`).innerText = newVal;
            },
            startWorkout: function() {
                AudioEngine.init();
                WakeLock.request();
                this.state.currentSet = 1;
                this.state.paused = false;
                this.state.elapsedTime = 0;
                this.state.laps = [];
                this.state.lafayAction = null; 
                document.getElementById('laps-container').classList.add('hidden-force');
                document.getElementById('laps-container').innerHTML = '';
                document.getElementById('timer-round-counter').classList.remove('hidden-force');
                document.getElementById('reps-visualizer').classList.remove('hidden-force');
                document.getElementById('controls-running').classList.add('hidden-force');
                document.getElementById('btn-restart').classList.remove('hidden-force'); 
                const btnPause = document.getElementById('btn-pause-toggle');
                if(btnPause) {
                    btnPause.innerText = "PAUSE";
                    btnPause.classList.remove('bg-yellow-600');
                    btnPause.classList.add('bg-gray-800/90');
                }
                this.showScreen('screen-timer');
                if (this.state.config.type === 'stopwatch') {
                    this.state.running = false; 
                    document.getElementById('timer-phase-label').innerText = "CHRONO";
                    document.getElementById('timer-round-counter').classList.add('hidden-force');
                    document.getElementById('reps-visualizer').classList.add('hidden-force');
                    document.getElementById('btn-restart').classList.add('hidden-force'); 
                    document.getElementById('sidebar-left-container').classList.add('hidden-force');
                    document.getElementById('sidebar-right-container').classList.add('hidden-force');
                    const timerDisp = document.getElementById('timer-display');
                    timerDisp.innerText = "0.0";
                    timerDisp.style.fontSize = "40vw"; 
                    timerDisp.classList.add('text-neon-volt'); 
                    document.getElementById('timer-sub-display').innerText = "SECONDES";
                    document.getElementById('controls-standard').classList.add('hidden-force');
                    document.getElementById('main-action-btn').classList.add('hidden-force');
                    document.getElementById('lafay-actions').classList.add('hidden-force'); 
                    document.getElementById('controls-running').classList.remove('hidden-force');
                    document.getElementById('laps-container').classList.remove('hidden-force');
                    const btnStop = document.getElementById('btn-stop-run');
                    btnStop.innerText = "START";
                    btnStop.classList.remove('bg-red-600');
                    btnStop.classList.add('bg-[var(--color-volt)]');
                } 
                else {
                    document.getElementById('sidebar-left-container').classList.remove('hidden-force');
                    document.getElementById('sidebar-right-container').classList.remove('hidden-force');
                    const timerDisp = document.getElementById('timer-display');
                    timerDisp.classList.remove('text-neon-volt'); 
                    timerDisp.style.fontSize = ""; 
                    this.setupVisualizer();
                    document.getElementById('controls-standard').classList.remove('hidden-force');
                    if (this.state.mode === 'lafay') {
                        document.getElementById('label-rest-reps').innerText = this.state.config.rest_reps + "s";
                        document.getElementById('label-rest-short').innerText = this.state.config.rest_short + "s";
                        document.getElementById('label-rest-long').innerText = this.state.config.rest_long + "s";
                    }
                    if (this.state.config.type === 'manual') this.setPhase('manual_work');
                    else this.setPhase('get_ready');
                }
            },
            restartWorkout: function() {
                document.getElementById('modal-confirm').classList.remove('hidden-force');
            },
            closeModal: function() {
                document.getElementById('modal-confirm').classList.add('hidden-force');
            },
            confirmRestart: function() {
                this.closeModal();
                AudioEngine.init(); 
                this.stopTimerLoop();
                this.startWorkout();
            },
            toggleRun: function() {
                const btn = document.getElementById('btn-stop-run');
                if (!this.state.running) {
                    this.state.running = true;
                    btn.innerText = "STOP";
                    btn.classList.remove('bg-[var(--color-volt)]');
                    btn.classList.add('bg-red-600');
                    this.state.intervalId = setInterval(() => {
                        this.state.elapsedTime += 0.1;
                        const timeStr = this.state.elapsedTime.toFixed(1);
                        const display = document.getElementById('timer-display');
                        display.innerText = timeStr;
                        if (timeStr.length >= 6) display.style.fontSize = "17vw"; 
                        else if (timeStr.length >= 5) display.style.fontSize = "22vw"; 
                        else if (timeStr.length >= 4) display.style.fontSize = "28vw"; 
                        else display.style.fontSize = "40vw"; 
                    }, 100);
                } else {
                    clearInterval(this.state.intervalId);
                    this.state.running = false;
                    btn.innerText = "START";
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-[var(--color-volt)]');
                }
            },
            recordLap: function() {
                if (this.state.laps.length >= 6) return;
                const time = this.state.elapsedTime.toFixed(1);
                this.state.laps.push(time);
                const div = document.createElement('div');
                div.className = "flex justify-between bg-gray-800 p-2 rounded text-lg font-mono border border-gray-600 text-white";
                div.innerHTML = `<span>TOUR ${this.state.laps.length}</span><span class="text-neon-volt">${time}s</span>`;
                document.getElementById('laps-container').prepend(div);
            },
            setPhase: function(phase) {
                const barLeft = document.getElementById('visual-bar-left');
                const barRight = document.getElementById('visual-bar-right');
                
                // MODIF YONI: Reset standard transitions
                barLeft.style.transition = 'none';
                barRight.style.transition = 'none';
                
                // --- GESTION COULEUR MAUVE ZEN ---
                if (this.state.mode === 'coherence') {
                    // Force la couleur mauve pour tout le mode cohérence
                    barLeft.style.backgroundColor = '#c084fc';
                    barRight.style.backgroundColor = '#c084fc';
                    
                    if (phase === 'work') { 
                        barLeft.style.height = '0%'; barRight.style.height = '0%'; 
                    } else if (phase === 'rest') { 
                        barLeft.style.height = '100%'; barRight.style.height = '100%'; 
                    }
                } else {
                    barLeft.style.height = '100%'; barRight.style.height = '100%';
                }
                
                barLeft.offsetHeight; // Force reflow
                
                if (this.state.mode !== 'coherence') {
                    barLeft.style.transition = 'height 1s linear';
                    barRight.style.transition = 'height 1s linear';
                }

                if (phase === 'work' && this.state.config.work === 0) { this.state.phase = 'work'; this.nextPhase(); return; }
                if (phase === 'hold' && this.state.config.hold === 0) { this.state.phase = 'hold'; this.nextPhase(); return; }
                if (phase === 'rest' && this.state.config.rest === 0) { this.state.phase = 'rest'; this.nextPhase(); return; }
                this.state.phase = phase;
                const phaseLabel = document.getElementById('timer-phase-label');
                const mainBtn = document.getElementById('main-action-btn');
                const lafayBtns = document.getElementById('lafay-actions');
                const stdControls = document.getElementById('controls-standard');
                const display = document.getElementById('timer-display');
                const subDisplay = document.getElementById('timer-sub-display');
                document.body.style.backgroundColor = '#000';
                display.className = "font-display text-[32vw] leading-none tabular-nums text-center drop-shadow-2xl";
                display.classList.remove('text-white', 'text-neon-volt', 'text-neon-alert', 'text-neon-zen'); 
                const zenColorClass = (this.state.mode === 'coherence') ? 'text-neon-zen' : 'text-white';
                if (phase === 'get_ready') {
                    this.state.timeLeft = 10; 
                    this.state.totalTime = 10;
                    phaseLabel.innerText = "PRÉPAREZ-VOUS"; phaseLabel.className = "text-3xl font-bold uppercase text-blue-400";
                    display.classList.add(zenColorClass);
                    subDisplay.innerText = "ATTENTION";
                    mainBtn.classList.add('hidden-force'); 
                    lafayBtns.classList.add('hidden-force');
                    stdControls.classList.remove('hidden-force');
                    AudioEngine.playBell(1000, 'square', 0.05, 0.1); 
                    this.runTimer();
                }
                else if (phase === 'work') {
                    this.state.timeLeft = this.state.config.work; this.state.totalTime = this.state.config.work;
                    if(this.state.mode === 'coherence') {
                        phaseLabel.innerText = "INSPIRER"; subDisplay.innerText = "INSPIRER";
                        phaseLabel.className = "text-3xl font-bold uppercase text-neon-zen";
                        display.classList.add('text-neon-zen');
                        AudioEngine.zenInhale();
                        barLeft.style.transition = `height ${this.state.totalTime}s linear`;
                        barRight.style.transition = `height ${this.state.totalTime}s linear`;
                        setTimeout(() => { barLeft.style.height = '100%'; barRight.style.height = '100%'; }, 50);
                    } else {
                        if (this.state.mode === 'boxing') {
                            phaseLabel.innerText = "EFFORT"; phaseLabel.className = "text-3xl font-bold uppercase text-neon-volt";
                            subDisplay.innerText = "FIGHT";
                            AudioEngine.beepTripleStart(); 
                        } else if (this.state.mode === 'tabata') {
                            phaseLabel.innerText = "EFFORT"; phaseLabel.className = "text-3xl font-bold uppercase text-neon-volt";
                            subDisplay.innerText = "GO !";
                            AudioEngine.beepTabataStart(); 
                        } else {
                            phaseLabel.innerText = "EFFORT"; phaseLabel.className = "text-3xl font-bold uppercase text-neon-volt";
                            subDisplay.innerText = "GO !";
                            AudioEngine.beepHigh(); 
                        }
                        display.classList.add('text-neon-volt'); 
                    }
                    mainBtn.classList.add('hidden-force');
                    lafayBtns.classList.add('hidden-force'); 
                    stdControls.classList.remove('hidden-force');
                    this.runTimer();
                }
                else if (phase === 'hold') {
                    this.state.timeLeft = this.state.config.hold; this.state.totalTime = this.state.config.hold;
                    phaseLabel.innerText = "MAINTENIR"; 
                    if(this.state.mode === 'coherence') {
                        phaseLabel.className = "text-3xl font-bold uppercase text-neon-zen";
                        display.classList.add('text-neon-zen');
                        subDisplay.innerText = "BLOCAGE";
                        AudioEngine.zenHold();
                        barLeft.style.height = '100%';
                        barRight.style.height = '100%';
                    } else {
                        phaseLabel.className = "text-3xl font-bold uppercase text-white";
                        display.classList.add('text-white');
                        subDisplay.innerText = "BLOCAGE";
                    }
                    mainBtn.classList.add('hidden-force'); 
                    lafayBtns.classList.add('hidden-force');
                    stdControls.classList.remove('hidden-force');
                    this.runTimer();
                }
                else if (phase === 'manual_work') {
                    const unitLabel = this.state.config.unit || "SÉRIE";
                    phaseLabel.innerText = "EFFORT"; 
                    phaseLabel.className = "text-3xl font-bold uppercase text-neon-volt";
                    display.innerText = "GO"; display.classList.add('text-neon-volt'); subDisplay.innerText = "FAITES VOS REPS";
                    if (this.state.mode === 'lafay') {
                        mainBtn.classList.add('hidden-force');
                        lafayBtns.classList.remove('hidden-force');
                    } else {
                        mainBtn.innerText = "SÉRIE TERMINÉE > REPOS"; 
                        mainBtn.className = "btn-tactical w-full py-10 text-2xl bg-[var(--color-volt)] text-black border-none rounded animate-pulse shadow-[0_0_30px_#CCFF00]";
                        mainBtn.classList.remove('hidden-force');
                        lafayBtns.classList.add('hidden-force');
                    }
                    stdControls.classList.add('hidden-force');
                    AudioEngine.beepHigh(); this.stopTimerLoop();
                }
                else if (phase === 'rest') {
                    this.state.timeLeft = this.state.config.rest; this.state.totalTime = this.state.config.rest;
                    if(this.state.mode === 'coherence') {
                        phaseLabel.innerText = "EXPIRER"; subDisplay.innerText = "EXPIRER";
                        phaseLabel.className = "text-3xl font-bold uppercase text-neon-zen";
                        display.classList.add('text-neon-zen');
                        AudioEngine.zenExhale(); 
                        barLeft.style.transition = `height ${this.state.totalTime}s linear`;
                        barRight.style.transition = `height ${this.state.totalTime}s linear`;
                        setTimeout(() => { barLeft.style.height = '0%'; barRight.style.height = '0%'; }, 50);
                    } else {
                        phaseLabel.innerText = "RÉCUP."; 
                        phaseLabel.className = "text-3xl font-bold uppercase text-neon-alert";
                        subDisplay.innerText = "RÉCUP.";
                        display.classList.add('text-neon-alert'); 
                        if(this.state.mode === 'boxing') AudioEngine.beepRoundEnd(); 
                        else AudioEngine.buzzer(); 
                    }
                    mainBtn.classList.add('hidden-force'); 
                    lafayBtns.classList.add('hidden-force');
                    stdControls.classList.remove('hidden-force');
                    document.body.classList.add('animate-alert');
                    this.runTimer();
                }
                else if (phase === 'finished') {
                    phaseLabel.innerText = "TERMINÉ"; display.innerText = "FIN"; 
                    display.classList.add(this.state.mode === 'coherence' ? 'text-neon-zen' : 'text-white');
                    subDisplay.innerText = "BRAVO";
                    if(this.state.mode === 'boxing') AudioEngine.beepEndFight(); 
                    else AudioEngine.playBell(600, 'square', 0.5, 0.5); 
                    document.body.classList.remove('animate-alert');
                    this.stopTimerLoop(); 
                    WakeLock.release();
                }
                this.updateUI();
            },
            updateTimerDisplay: function() {
                if (this.state.phase === 'finished') return;
                const display = document.getElementById('timer-display');
                let timeStr;
                if (this.state.timeLeft >= 60) {
                    const m = Math.floor(this.state.timeLeft / 60);
                    const s = this.state.timeLeft % 60;
                    timeStr = `${m}:${s < 10 ? '0'+s : s}`;
                    display.style.fontSize = "22vw"; 
                } else {
                    timeStr = this.state.timeLeft;
                    display.style.fontSize = "32vw"; 
                }
                display.innerText = timeStr;
                if (this.state.totalTime > 0) {
                    const percentage = (this.state.timeLeft / this.state.totalTime) * 100;
                    let barColor;
                    if (this.state.mode === 'coherence') {
                        // COULEUR GÉRÉE DANS setPhase()
                    } 
                    else {
                        if (this.state.phase === 'rest') barColor = 'var(--color-alert)';
                        else if (this.state.phase === 'hold') barColor = 'white';
                        else if (this.state.phase === 'get_ready') barColor = '#fff';
                        else barColor = 'var(--color-volt)';
                        document.getElementById('visual-bar-left').style.height = `${percentage}%`;
                        document.getElementById('visual-bar-right').style.height = `${percentage}%`;
                        document.getElementById('visual-bar-left').style.backgroundColor = barColor;
                        document.getElementById('visual-bar-right').style.backgroundColor = barColor;
                    }
                }
            },
            setupVisualizer: function() {
                const container = document.getElementById('reps-visualizer');
                container.innerHTML = '';
                const isCompact = this.state.config.sets > 15;
                for(let i=1; i<=this.state.config.sets; i++) {
                    const box = document.createElement('div');
                    const sizeClass = isCompact ? 'w-4 h-4' : 'w-8 h-8';
                    box.className = `${sizeClass} border-2 border-gray-600 rounded-sm`;
                    box.id = `rep-box-${i}`;
                    container.appendChild(box);
                }
            },
            updateUI: function() {
                const isCompact = this.state.config.sets > 15;
                const sizeClass = isCompact ? 'w-4 h-4' : 'w-8 h-8';
                const unit = this.state.config.unit || "SÉRIE";
                document.getElementById('timer-round-counter').innerText = `${unit} ${this.state.currentSet} / ${this.state.config.sets}`;
                for(let i=1; i<=this.state.config.sets; i++) {
                    const box = document.getElementById(`rep-box-${i}`);
                    if (i < this.state.currentSet) box.className = `${sizeClass} bg-gray-600 rounded-sm opacity-50`;
                    else if (i === this.state.currentSet) box.className = `${sizeClass} bg-white shadow-[0_0_15px_white] rounded-sm scale-110 transition-transform border-none`;
                    else box.className = `${sizeClass} border-2 border-gray-700 bg-transparent rounded-sm`;
                }
            }
        };

        window.addEventListener('load', () => {
            const setVH = () => {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            setVH();
            window.addEventListener('resize', setVH);
        });
    </script>
</body>
</html>
